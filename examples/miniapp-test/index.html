<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Farcaster MiniApp Test Environment</title>
  <style>
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f0f0f0;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      padding: 20px;
    }
    .phone-frame {
      background: #000;
      border-radius: 30px;
      padding: 10px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.3);
    }
    .screen {
      background: #fff;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
    }
    .status-bar {
      background: #8b5cf6;
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .primary-button {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 20px;
      cursor: pointer;
      font-weight: 500;
    }
    .primary-button:hover {
      background: #7c3aed;
    }
    .iframe-container {
      width: 100%;
      height: 600px;
      border: none;
    }
    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }
    .controls {
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    .control-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    button {
      background: #8b5cf6;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #7c3aed;
    }
    .log {
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin-top: 10px;
      font-family: monospace;
      font-size: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Farcaster MiniApp Test Environment</h1>
    
    <div class="phone-frame">
      <div class="screen">
        <div class="status-bar">
          <span>Farcaster</span>
          <button id="primaryButton" class="primary-button">Share</button>
        </div>
        <div class="iframe-container">
          <iframe id="miniapp" src="http://localhost:5173"></iframe>
        </div>
      </div>
    </div>

    <div class="controls">
      <h2>Test Controls</h2>
      
      <div class="control-group">
        <label>User FID:</label>
        <input type="number" id="fid" value="1234" />
      </div>
      
      <div class="control-group">
        <label>Username:</label>
        <input type="text" id="username" value="testuser" />
      </div>
      
      <div class="control-group">
        <label>Display Name:</label>
        <input type="text" id="displayName" value="Test User" />
      </div>
      
      <div class="control-group">
        <label>Launch Context:</label>
        <select id="locationType">
          <option value="cast_embed">Cast Embed</option>
          <option value="cast_share">Cast Share</option>
          <option value="notification">Notification</option>
          <option value="launcher">Launcher</option>
          <option value="channel">Channel</option>
        </select>
      </div>
      
      <button onclick="injectSDK()">Inject SDK & Load</button>
      <button onclick="simulatePrimaryClick()">Trigger Primary Button</button>
      
      <div class="log" id="log"></div>
    </div>
  </div>

  <script>
    const iframe = document.getElementById('miniapp');
    const primaryButton = document.getElementById('primaryButton');
    const log = document.getElementById('log');

    function addLog(message) {
      const timestamp = new Date().toLocaleTimeString();
      log.innerHTML += `[${timestamp}] ${message}<br>`;
      log.scrollTop = log.scrollHeight;
    }

    // Update primary button text when SDK calls setPrimaryButton
    window.addEventListener('message', (event) => {
      if (event.data.type === 'setPrimaryButton') {
        primaryButton.textContent = event.data.text;
        addLog(`Primary button text set to: "${event.data.text}"`);
      } else if (event.data.type === 'ready') {
        addLog('MiniApp signaled ready!');
      } else if (event.data.type === 'composeCast') {
        addLog(`Compose cast requested: "${event.data.text}"`);
        alert(`Cast composed:\n\n${event.data.text}`);
      }
    });

    function injectSDK() {
      const fid = document.getElementById('fid').value;
      const username = document.getElementById('username').value;
      const displayName = document.getElementById('displayName').value;
      const locationType = document.getElementById('locationType').value;

      // Create mock SDK
      const mockSDK = `
        window.__FARCASTER_MINIAPP_CONTEXT__ = {
          user: {
            fid: ${fid},
            username: "${username}",
            displayName: "${displayName}"
          },
          location: {
            type: "${locationType}"
          },
          client: {
            clientFid: 1,
            added: false,
            safeAreaInsets: {
              top: 20,
              bottom: 34,
              left: 0,
              right: 0
            }
          }
        };

        // Mock SDK implementation
        window.mockSdk = {
          isInMiniApp: async () => true,
          context: Promise.resolve(window.__FARCASTER_MINIAPP_CONTEXT__),
          actions: {
            ready: async () => {
              window.parent.postMessage({ type: 'ready' }, '*');
              console.log('MiniApp ready signaled');
            },
            setPrimaryButton: (options) => {
              window.parent.postMessage({ type: 'setPrimaryButton', text: options.text }, '*');
              console.log('Primary button set:', options);
            },
            composeCast: async (options) => {
              window.parent.postMessage({ type: 'composeCast', text: options.text }, '*');
              console.log('Compose cast:', options);
            }
          },
          on: (event, handler) => {
            window.__farcasterHandlers = window.__farcasterHandlers || {};
            window.__farcasterHandlers[event] = handler;
          },
          off: (event) => {
            if (window.__farcasterHandlers) {
              delete window.__farcasterHandlers[event];
            }
          }
        };

        // Replace the real SDK with our mock
        if (window.sdk) {
          Object.assign(window.sdk, window.mockSdk);
        } else {
          window.sdk = window.mockSdk;
        }

        // Trigger any pending SDK checks
        window.dispatchEvent(new Event('farcaster-sdk-ready'));
      `;

      iframe.contentWindow.eval(mockSDK);
      addLog('SDK injected and miniapp loaded');
    }

    function simulatePrimaryClick() {
      iframe.contentWindow.eval(`
        if (window.__farcasterHandlers && window.__farcasterHandlers.primaryButtonClicked) {
          window.__farcasterHandlers.primaryButtonClicked();
          console.log('Primary button clicked');
        }
      `);
      addLog('Primary button click simulated');
    }

    // Auto-inject after iframe loads
    iframe.onload = () => {
      setTimeout(() => {
        addLog('MiniApp iframe loaded');
        // Give the app time to initialize before injecting
        setTimeout(injectSDK, 1000);
      }, 500);
    };
  </script>
</body>
</html>